service: lights-out

provider:
  name: aws
  # Profile is set via AWS_PROFILE environment variable (managed by run-interactive.js)
  region: ${opt:region}
  stage: ${opt:stage}
  runtime: nodejs24.x

  iam:
    role:
      statements:
        - Effect: Allow
          Action: [ssm:GetParameter]
          Resource:
            Fn::Sub: 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lights-out/${self:provider.stage}/*'
        - Effect: Allow
          Action: [tag:GetResources]
          Resource: '*'
        - Effect: Allow
          Action:
            - ecs:DescribeServices
            - ecs:UpdateService
            - ecs:ListServices
            - ecs:DescribeClusters
          Resource: '*'
        - Effect: Allow
          Action:
            - application-autoscaling:DescribeScalableTargets
            - application-autoscaling:RegisterScalableTarget
          Resource: '*'
        - Effect: Allow
          Action:
            - rds:DescribeDBInstances
            - rds:StartDBInstance
            - rds:StopDBInstance
          Resource: '*'
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
        - Effect: Allow
          Action:
            - sts:GetCallerIdentity
          Resource: '*'

  environment:
    CONFIG_PARAMETER_NAME: /lights-out/${self:provider.stage}/config
    LOG_LEVEL: ${opt:loglevel, 'DEBUG'}

functions:
  handler:
    name: lights-out-${self:provider.stage}
    handler: src/functions/handler/index.main
    runtime: nodejs24.x
    timeout: 300
    memorySize: 512
    tags:
      project: lights-out
      managed-by: serverless
    # Dynamic schedules generated from config file
    # Supports both legacy (schedules_cron) and regional (group_schedules) modes
    events: ${file(./scripts/generate-schedules.js):events}

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    external: []
    target: node24
    platform: node

  # Config file path is dynamically resolved by generate-schedules.js
  # by scanning scripts/arguments/*.json files for matching stage name

plugins:
  - serverless-esbuild

# CloudFormation resources
# NOTE: SSM Parameter is created manually due to CloudFormation Early Validation issues
resources: {}
