service: lights-out

provider:
  name: aws
  region: ap-southeast-1
  stage: ${opt:stage, 'sss-lab'}  # 對應 AWS 帳號名稱

  iam:
    role:
      statements:
        - Effect: Allow
          Action: [ssm:GetParameter]
          Resource: arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/lights-out/*
        - Effect: Allow
          Action: [tag:GetResources]
          Resource: "*"
        - Effect: Allow
          Action:
            - ecs:DescribeServices
            - ecs:UpdateService
            - ecs:ListServices
            - ecs:DescribeClusters
          Resource: "*"
        - Effect: Allow
          Action:
            - rds:DescribeDBInstances
            - rds:StartDBInstance
            - rds:StopDBInstance
          Resource: "*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

  environment:
    CONFIG_PARAMETER_NAME: /lights-out/config  # 同帳號內只有一個配置
    LOG_LEVEL: ${opt:loglevel, 'INFO'}

functions:
  lights-out:
    handler: src/index.main
    runtime: nodejs20.x
    timeout: 300
    memorySize: 512
    tags:
      project: lights-out
      managed-by: serverless
    events:
      # Start resources at 9:00 AM Taipei time (01:00 UTC)
      - schedule:
          name: ${self:service}-${self:provider.stage}-start
          description: Start resources at 9:00 AM Asia/Taipei
          rate: cron(0 1 ? * MON-FRI *)
          input:
            action: start
          enabled: true
      # Stop resources at 7:00 PM Taipei time (11:00 UTC)
      - schedule:
          name: ${self:service}-${self:provider.stage}-stop
          description: Stop resources at 7:00 PM Asia/Taipei
          rate: cron(0 11 ? * MON-FRI *)
          input:
            action: stop
          enabled: true

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    external: []
    target: node20
    platform: node

plugins:
  - serverless-esbuild

# CloudFormation resources
resources:
  Resources:
    # SSM Parameter for configuration
    LightsOutConfigParameter:
      Type: AWS::SSM::Parameter
      Properties:
        Name: /lights-out/config
        Type: String
        Description: Lights Out configuration for ${self:provider.stage} environment
        # Load configuration from external file based on stage
        Value: ${file(./config/${self:provider.stage}.yml)}
        Tags:
          - Key: project
            Value: lights-out
          - Key: managed-by
            Value: serverless
          - Key: stage
            Value: ${self:provider.stage}
